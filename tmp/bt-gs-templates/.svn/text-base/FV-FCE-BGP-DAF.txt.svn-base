interfaces {
    $physical_interface {
        unit $logical_interface {
            /* vrf $vrfname */
            description "$unit_interface_description";
            vlan-id $vlan_id;
            family inet {
                mtu 1500;
                address $ipaddress/30;
                filter {
                    input-list [ $control_filter $vrf_aggregate_filter $vrf_cos_filter ];
                    output-list [ acl-out-fce-connection finex-BFD-BGP-PIM-out $AF2_SAN_filter AF2-rtq-out-default $AF1_SAN_filter $Fix_filter AF1-out-default ];
                }
            }
        }
    }
    lo0 {
        unit $vrf_lo0_logical_int {
            /* vrf $vrfname */
            description "$vrf_lo0_int_descr";
            family inet {
                filter {
                    input protect-RE-VRF;
                }
                address $vrf_lo0_ip_addr/32;
            }
        }
    }
}
policy-options {
    prefix-list acl-ebgp-in-$vrfname {
        $prefix$/$prefix_mask$
        $prefixn$/$prefixn_mask$
    }
    prefix-list allowed-srcs-$subint {
        $prefix1/$prefix1_mask;
        $prefixn/$prefixn_mask;
    }
    policy-statement fv-import-$vrfname {
        term deny-TR-spoke-community {
            from {
                protocol bgp;
                community FE-TR-CLIENT-COM;
            }
            then reject;
        }
		term import-TR-provider-agg-RT {
            from {
                protocol bgp;
                community TR-provider-agg-RT;
            }
            then accept;
        }
        term import-FCE-member-hub-RTs {
            from {
                protocol bgp;
                community RT-community-12641:900649;
            }
            then accept;
        }           
        term import-FCE-provider-spoke-RTs {
            from {
                protocol bgp;
                community RT-community-12641:900649;
            }
            then accept;
        }
    }
    policy-statement fv-export-$vrfname {
        term PE-Lo99xx {
            from {
                protocol direct;
                prefix-list-filter temp-PE-loops orlonger;
            }
            then {
                community add FV-COMMUNITY-SET;
                community add BT-MPLS-PE-VRF-loopback-SET;
                community add $vrfname-FCE-member-spoke-RTs;
                community add $vrfname-FCE-provider-hub-RTs;
                accept;
            }
        }
        term permit-static-fv-loop10s {
            from {
                protocol static;
                prefix-list-filter fv-loop10s orlonger;
            }
            then {
                community add $vrfname-FCE-member-spoke-RTs;
                community add $vrfname-FCE-provider-hub-RTs;
                accept;
            }
        }
        term export-FCE-hub-and-spoke-RTs {
            from {
                protocol bgp;
                community FE-FCE-CLIENT-AND-PROVIDER-COM;
            }
            then {
                community add $vrfname-FCE-member-spoke-RTs;
                community add $vrfname-FCE-provider-hub-RTs;
                accept;
            }
        }
       term export-FCE-spoke-RTs {
            from {
                protocol bgp;
                community FE-FCE-CLIENT-COM;
            }
            then {
                community add $vrfname-FCE-member-spoke-RTs;
                accept;
            }
        }
        term export-FCE-hub-RTs {
            from {
                protocol bgp;
                community FE-FCE-PROVIDER-COM;
            }
            then {
                community add $vrfname-FCE-provider-hub-RTs;
                accept;
            }
        }
    }
    policy-statement rm-ebgpin-$vrfname-$site_id {
        term deny-dummy-subnet {
            from {
                protocol bgp;
              prefix-list finex-wan-primary;
            }
            then {
                reject;
            }
        }
        term permit-vrf-prefixes {
            from {
                protocol bgp;
                prefix-list acl-ebgpin-$vrfname-$site_id;
            }
            then {
                community delete BT-MPLS-internal-wildcard;
                community delete UK-MPLS-internal-wildcard;
                community delete all-Origins;
                community delete BT-MPLS-all-RTs;
                community add $topology_community;
                community add $prim_backup_community;
                accept;
			}
        }
    }
    policy-statement soo-import-$vrfname-$site_id {
        term set-soo {
            then {
                community add SOO-COMMUNITY_$vrfname-$site_id;
            }
        }
        term evaluate-next {
            then next policy;
        }
    }
    policy-statement soo-export-$vrfname-$site_id {
        term reject-soo {
            from community SOO-COMMUNITY_$vrfname-$site_id;
            then reject;
        }
        term evaluate-next {
            then next policy;
        }
    }
	community $vrfname-FCE-member-spoke-RTs members target:12641:900650;
    community $vrfname-FCE-provider-hub-RTs members target:12641:900650;
    community SOO-COMMUNITY_$vrfname-$site_id members origin:$CE_ASN:$SoO_export_RT;
}
firewall {
    policer $agg_policer_name {
        if-exceeding {
            bandwidth-limit $vrf_agg_police_bw;
            burst-size-limit $vrf_agg_police_burst;
            }
        then {
            discard;
        }
    }
    policer AF1_$subint {
        if-exceeding {
            bandwidth-limit $vrf_af1_bw;
            burst-size-limit $vrf_af1_burst;
        }
        then {
            loss-priority low;
            forwarding-class FC-Q6;
        }
    }
    family inet {
        filter $agg_filter_name {
            interface-specific;
            term sp-ping {                   
                from {
                    source-prefix-list {
                        sp-ping-$subint;
                    }
                    protocol icmp;
                    icmp-type-except echo-reply;
                }                                   
                then {
                    count sp-ping-discard;
                    discard;
                }
            }
            term allowed-srcs-except {
                from {
                    source-prefix-list {
                        allowed-srcs-$subint except;
                    }
                }
                then {
                    count discard-traffic;
                    discard;
                }
            }
            term Agg-policer {
                then {
                    policer $agg_policer_name;
                    count all-permitted;
                    next term;
                }
            }
        }
        filter finex-cos-$subint {
            term AF1_in {
                from {
                    dscp af11;
                }
                then {
                    policer AF1_$subint;
                    count AF_in;
                    loss-priority low;
                    forwarding-class FC-Q6;
                    accept;
                }
            }
            term AF1_out { 
                from {
                    dscp [ af12 af13 ];
                }
                then {
                    count AF1_out;
                    loss-priority high;
                    forwarding-class FC-Q6;
                    accept;
                }   
            }
            term default {
                then {
                    count BE;
                    loss-priority low;
                    forwarding-class FC-Q4;
                    accept;
                }
            }
        }
        filter $AF2_SAN_filter_name {
            apply-groups $SAN_name;

            term $SAN_name-1-all {
                then count $SAN_name-all;
            }
            term $SAN_name-1-pol {

                then three-color-policer {
                    single-rate $SAN_policer_name;
                }
            }
                then {
                    policer $SAN_policer_name;
                    loss-priority low;
                }
            }
            term $SAN_name-1-ic {
                then count $SAN_name-ic;
            }
            term $SAN_name-1-oc {
                then count $SAN_name-oc;
            }
		}
        filter $AF1_SAN_filter_name {
            apply-groups $SAN_name;
            term $SAN_name-1-all {
                then count $SAN_name-all;
            }
            term $SAN_name-1-pol {

                then three-color-policer {
                    single-rate $SAN_policer_name;
                }
            }

                then {
                    policer $SAN_policer_name;
                    loss-priority low;
                }
            }

            term $SAN_name-1-ic {
                then count $SAN_name-ic;
            }
            term $SAN_name-1-oc {
                then count $SAN_name-oc;
            }
		}
    }
}
routing-instances {
    $vrfname {
        instance-type vrf;
        interface lo0.$grey_vrf_lo0_logical_int;
        interface $physical_interface.$logical_interface;
        route-distinguisher $ASN:$RD_number;
        vrf-import $import_policy_statement;
        vrf-export $export_policy_statement;
        vrf-table-label;
        routing-options {
            static {
                route $ce_loopback10/32 {
                    next-hop $ce-wan-ip;
                    bfd-liveness-detection {
                        no-adaptation;
                        minimum-interval 999;
                        multiplier 3;
                    }
                    community [ 12641:65050 12641:6125 ];
                }
                route $no_converge_prefix/$no_converge_prefix_mask {
                    next-hop $ce-wan-ip;
                    tag 6137;
                    retain;
                    community [16579:3001 12641:6125 ];
                }
                route $ce-wan-ip/32 {
                    next-hop $ce-wan-ip;
                    bfd-liveness-detection {
                        no-adaptation;
                        minimum-interval $bfd_minimum_interval;
                        multiplier $bfd_multiplier;
                    }
                    no-readvertise;
                }
            }
            auto-export;
            multipath;
        }
        forwarding-options {
            family inet {
                filter {
                    output $mcast_SAN_filter;
                }
            }
        }
        protocols {
            bgp {
                damping;
                group ebgp {
                    type external;
                    log-updown;
                    neighbor $ce-wan-ip {
                        hold-time 30;
                        import [ CUSTOMER-BGP-DAMPING rm-ebgpin-$vrfname-$site_id soo-import-$vrfname-$site_id  ];
                        family inet {
                            any {
                                prefix-limit {
                                    maximum 500;
                                    teardown 50 idle-timeout forever;
                                }
                            }
                        }
                        export [ soo-export-$vrfname-$site_id  DENYBTPREFIX-SPRING ];
                        bfd-liveness-detection {
                            no-adaptation;
                            minimum-interval $bfd_minimum_interval$;
                            multiplier $bfd_multiplier$;
                        }
                        peer-as $CE_ASN;
                        as-override;
                    }
                }
            }
        }
    }
}
