interfaces {
    $physical_interface$  {
        description "$physical_interface_description$";
        traps;
        vlan-tagging;
        hierarchical-scheduler;
        mtu 1518;
        hold-time up 2000 down 2000;
        unit $logical_interface$ {
            description $subinterface_description$;
            vlan-id $logical_interface$;
            family inet {
                mtu 1500;
                address $pe_int_addr$/30;
            }
        }
    }
	lt-$fpc$/$pic$/10 {
        unit $subinterface_ID_1$ {
            description "Interconnects VRF $customer_vrf_name$ -> VRF $transport_vrf_name$";
            encapsulation vlan;
            vlan-id 100;
            peer-unit $subinterface_ID_2$;
            family inet {
                address $even_numbered_ip_address$/31;
            }
        }
        unit $subinterface_ID_2$  {
            description "Interconnects VRF $transport_vrf_name$ -> VRF $customer_vrf_name$";
            encapsulation vlan;
            vlan-id 100;
            peer-unit $subinterface_ID_1$;
            family inet {
                address $odd_numbered_ip_address$/31;
            }
        }
    }
    lo0 {
        unit $vrf_lo0_logical_int$ {
            description "$vrf_lo0_int_descr$";
            family inet {
                address $dummy_ip_address$/32;
                address $vrf_lo0_ip_addr$/32  {
                    primary;
                    preferred;
                }
            }
        }
    }
}
policy-options {
    community $multicast_provider_vrf_import_rt_set$ members target:12641:$Client_VPN_RT$;
    policy-statement $multicast_provider_vrf_import_policy$ {
        term VPN-routes {
            from {
                protocol bgp;
                community $multicast_provider_vrf_import_rt_set$;
            }
            then accept;
        }
        term explicit-deny {
            then reject;
        }
    }
    community $multicast_provider_vrf_export_rt_set_1$ members target:12641:$Provider_VPN_RT$;
    community $multicast_provider_vrf_export_rt_set_2$ members target:12641:$Provider_RP_RT$;
    policy-statement $multicast_provider_vrf_export_policy$ {
        term block-dummy-loopback {
            from {
                protocol direct;
                route-filter $dummy_ip_address$/32 exact;
            }
            then reject;
        }
        term RP {
            from {
                protocol bgp;
                route-filter $RP_address$/32 exact;
            }
            then {
                community add $multicast_provider_vrf_export_rt_set_2$;
                community add community-BLUE-CORE-DIVERSITY-1;
                /* substitute with "community add community-RED-CORE-DIVERSITY-1;" on RED PEs */
                community add community-BLUE-CORE-DIVERSITY-2;
                /* substitute with "community add community-RED-CORE-DIVERSITY-2;" on RED PEs */

                accept;
            }
        }
        term VPN-routes {
            from {
                protocol bgp;
            }
            then {
                community add $multicast_provider_vrf_export_rt_set_1$;
                community add community-BLUE-CORE-DIVERSITY-1;
                /* substitute with "community add community-RED-CORE-DIVERSITY-1;" on RED PEs */
                community add community-BLUE-CORE-DIVERSITY-2;
                /* substitute with "community add community-RED-CORE-DIVERSITY-2;" on RED PEs */
                accept;
            }
        }
        term explicit-deny {
            then reject;
        }
    }
    policy-statement $multicast_provider_vrf_export_policy$ {
        term block-dummy-loopback {
            from {
                protocol direct;
                route-filter $dummy_ip_address$/32 exact;
            }
            then reject;
        }
        term RP {
            from {
                protocol bgp;
                route-filter $RP_address$/32 exact;
            }
            then {
                community add $multicast_provider_vrf_export_rt_set_2$;
                community add community-BLUE-CORE-DIVERSITY-1;
                /* substitute with "community add community-RED-CORE-DIVERSITY-1;" on RED PEs */
                community add community-BLUE-CORE-DIVERSITY-2;
                /* substitute with "community add community-RED-CORE-DIVERSITY-2;" on RED PEs */

                accept;
            }
        }
        term VPN-routes {
            from {
                protocol bgp;
            }
            then {
                community add $multicast_provider_vrf_export_rt_set_1$;
                community add community-BLUE-CORE-DIVERSITY-1;
                /* substitute with "community add community-RED-CORE-DIVERSITY-1;" on RED PEs */
                community add community-BLUE-CORE-DIVERSITY-2;
                /* substitute with "community add community-RED-CORE-DIVERSITY-2;" on RED PEs */
                accept;
            }
        }
        term explicit-deny {
            then reject;
        }
    }
    
}
routing-instances {
    $multicast_provider_vrf_name$ {
        instance-type vrf;
        interface lo0.$vrf_lo0_logical_int$;
        interface $physical_interface$.$logical_interface$;
        interface lt-$fpc$/$pic$/10.$subinterface_ID_1$;
        route-distinguisher 12641:$RD$;
        vrf-import $multicast_provider_vrf_import_policy$;
        vrf-export $multicast_provider_vrf_export_policy$;
        vrf-table-label;
        routing-options {
            auto-export;
        }
        protocols {
            bgp {
                damping;
                group ebgp {
                    type external;
                    log-updown;
                    neighbor $CE_ip_address$ {
                        import [ CUSTOMER-BGP-DAMPING $CE_import_policy$ ];
                        export $CE_export_policy$;
                        peer-as $CE_AS_Number$;
                        hold-time 30;
                        out-delay 0;
                        family inet {
                            any {
                                prefix-limit {
                                    maximum $prefix_limit$;
                                    teardown $threshold$ idle-timeout forever;
                            		}
                        		}
                    		}
                    		bfd-liveness-detection {
                            no-adaptation;
                            minimum-interval $bfd_minimum_interval$;
                            multiplier $bfd_multiplier$;
                        }
                }
                group transport_vrf {
                    type internal;
                    neighbor $odd_numbered_ip_address$ {
                        export ibgp-set-next-hop-self;
                    }
                }
            }
            pim {
                rp {
                    static {
                        address $RP_address$ {
                             group-ranges {
                               $customer_multicast_group_address$/32;
                            }
                        }
                    }
                }
                interface $physical_interface$.$logical_interface$ {
                    mode sparse;
                    version 2;
                }
                interface lt-$fpc$/$pic$/10.$subinterface_ID_1$;
            }
        }
    }
	$transport_vrf_name$ {
		interface lt-$fpc$/$pic$/10.$subinterface_ID_2$;
		protocols {
			bgp {
		        group provider_vrf {
		            type internal;
		            neighbor $even_numbered_ip_address$ {
		                export deny-all;
		            }
		        }                  
		    }
			pim {
				interface lt-$fpc$/$pic$/10.$subinterface_ID_2$;
			}
		}
	}
}
