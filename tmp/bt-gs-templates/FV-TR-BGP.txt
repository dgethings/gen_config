interfaces {
    [% vrf.ifd %] {
        unit [% vrf.ifl %] {
            vlan-id [% vrf.ifl %]$;
            family inet {
                mtu 1500;
                address 62.6.28.1/30;
                filter {
                    input-list [ finex-control agg_vrf_[% vrf.rt %]_[% vrf.ifd %].[% vrf.ifl %] finex-cos-[% vrf.ifd %].[% vrf.ifl %] ];
                    output-list [ finex-BFD-BGP-PIM-out AF2_SAN_vrf_[% vrf.rt %] AF2-rtq-out-default AF1_SAN_vrf_[% vrf.rt %] AF1-out-default ];
                }
            }
        }
    }
    lt-[% vrf.fpc %]/[% vrf.pic %]/10 {
        unit [% vrf.lt_ifl_1 %] {
            encapsulation vlan;
            vlan-id 100;
            peer-unit [% vrf.lt_ifl_2 %];
            family inet {
                address 108.116.0.0/31;
            }
        }
        unit [% vrf.lt_ifl_2 %]  {
            encapsulation vlan;
            vlan-id 100;
            peer-unit [% vrf.lt_ifl_1 %];
            family inet {
                address 108.116.0.1/31;
            }
        }
    }
    lo0 {
        unit [% vrf.lo0_unit %] {
            family inet {
                filter {
                    input protect-RE-VRF;
                }
                address [% vrf.lo0_ip_addr %]/32;
            }
        }
    }
}
policy-options {
    prefix-list allowed-srcs-[% vrf.ifd %]$.[% vrf.ifl %]$ {
        $src_nat_prefix/$src_mask$;
    }
    prefix-list acl-ebgp-in-$vrf$ {
        $prefix$/$prefix_mask$
        $prefixn$/$prefixn_mask$
    }
    policy-statement fv-import-$vrf$ {
        term import-TR-hub-RTs {
            from {
                protocol bgp;
                community RT-community-12641:9685;
            }
            then accept;
        }
    }
    policy-statement fv-export-$vrf$ {
        term PE-Lo99xx {
            from {
                protocol direct;
                prefix-list-filter temp-PE-loops orlonger;
            }
            then {
                community add FV-COMMUNITY-SET;
                community add BT-MPLS-PE-VRF-loopback-SET;
                community add $vrf$-TR-spoke-RTs;
                accept;
            }
        }
        term permit-static-fv-loop10s {
            from {
                protocol static;
                prefix-list-filter fv-loop10s orlonger;
            }
            then {
                community add $vrf$-TR-spoke-RTs;
                accept;
            }
        }
        term permit-no-converge {
            from {
                protocol static;
                tag 6137;
            }
            then {
                community add FV-COMMUNITY-SET;
                community add FE-TR-CLIENT-COM;
                community add $vrf$-TR-spoke-RTs;
                accept;
            }
        }
        term export-TR-spoke-RTs {
            from {
                protocol bgp;
                community FE-TR-CLIENT-COM;
            }
            then {
                community add $vrf$-TR-spoke-RTs;
                accept;
            }
        }
    }
    policy-statement rm-ebgpin-$vrf$-$site_id$ {
        term deny-dummy-subnet {
            from {
                protocol bgp;
              prefix-list finex-wan-primary;
            }
            then {
                reject;
            }
        }
        term permit-vrf-prefixes {
            from {
                protocol bgp;
                prefix-list acl-ebgpin-$vrf$-$site_id$;
            }
            then {
                community delete BT-MPLS-internal-wildcard;
                community delete UK-MPLS-internal-wildcard;
                community delete all-Origins;
                community delete BT-MPLS-all-RTs;
                community add $topology_community;
                community add $prim_backup_community;
                accept;
			}
        }
    }
    policy-statement soo-import-$vrf$-$site_id$ {
        term set-soo {
            then {
                community add SOO-COMMUNITY_$vrf$-$site_id$;
            }
        }
        term evaluate-next {
            then next policy;
        }
    }
    policy-statement soo-export-$vrf$-$site_id$ {
        term reject-soo {
            from community SOO-COMMUNITY_$vrf$-$site_id$;
            then reject;
        }
        term evaluate-next {
            then next policy;
        }
    }
    community $vrf$-TR-spoke-RTs members target:12641:9686;
    community SOO-COMMUNITY_$vrf$-$site_id$ members origin:$CE_ASN:$SoO_export_RT;
}
class-of-service {
		drop-profiles {
		    afx1_traffic_in-contract_drop_profile {
		        fill-level 50 drop-probability 0;
		        fill-level 99 drop-probability 10;
		    }
		    afx2_traffic_near-contract_drop_profile {
		        fill-level 15 drop-probability 0;
		        fill-level 40 drop-probability 10;
		    }
		    afx3_traffic_out-contract_drop_profile {
		        fill-level 6 drop-probability 0;
		        fill-level 14 drop-probability 20;
		    }
		}
		forwarding-classes {
		    class FC-Q6 queue-num 6;
		    class FC-Q4 queue-num 4;
		    class FC-Q3 queue-num 3;
		    class FC-Q2 queue-num 2;
		    class FC-Q1 queue-num 1;
		    class FC-Q0 queue-num 0;
		    class FC-Q7 queue-num 7;
		    class FC-Q5 queue-num 5;
		    class FC-Q4-Bleach queue-num 4;
		    class FC-EXP0-Q4 queue-num 4;
		}
		traffic-control-profiles {
	    	$tcp_name$ {
		        scheduler-map $sched_map_name$;
		        shaping-rate $shaping_rate$;
		    }
		}
		interfaces {
	        [% vrf.ifd %] {
	            unit [% vrf.ifl %] {
	                output-traffic-control-profile traff_ctrl_prof_$vrf_name$_$interface$;
	            }
	        }
		}
		scheduler-maps {
		        $sched_map_name$ {
		            forwarding-class FC-Q1 scheduler af1_$vrf_name$_$interface$;
		            forwarding-class FC-Q2 scheduler af2_$vrf_name$_$interface$;
		            forwarding-class FC-Q7 scheduler af3_$vrf_name$_$interface$;
		            forwarding-class FC-Q4 scheduler dflt_$vrf_name$_$interface$;
		            forwarding-class FC-Q3 scheduler ctrl_$vrf_name$_$interface$;
		        }
		}
		schedulers {
	        af1_$vrf_name$_$interface$ {
	            transmit-rate percent $af1_bw$;
	            buffer-size percent $af1_buff$;
	            priority low;
	            drop-profile-map loss-priority low protocol any drop-profile afx1_traffic_in-contract_drop_profile;
	            drop-profile-map loss-priority medium-high protocol any drop-profile afx2_traffic_near-contract_drop_profile;
	            drop-profile-map loss-priority high protocol any drop-profile afx3_traffic_out-contract_drop_profile;
	        }
	        af2_$vrf_name$_$interface$ {
	            transmit-rate percent $af2_bw$;
	            buffer-size percent $af2_buff$;
	            priority low;
	            drop-profile-map loss-priority low protocol any drop-profile afx1_traffic_in-contract_drop_profile;
	            drop-profile-map loss-priority medium-high protocol any drop-profile afx2_traffic_near-contract_drop_profile;
	            drop-profile-map loss-priority high protocol any drop-profile afx3_traffic_out-contract_drop_profile;
	        }
	        af3_$vrf_name$_$interface$ {
	            transmit-rate percent $af3_bw$;
	            buffer-size percent $af3_buff$;
	            priority low;
	            drop-profile-map loss-priority low protocol any drop-profile afx1_traffic_in-contract_drop_profile;
	            drop-profile-map loss-priority medium-high protocol any drop-profile afx2_traffic_near-contract_drop_profile;
	            drop-profile-map loss-priority high protocol any drop-profile afx3_traffic_out-contract_drop_profile;
	        }
	        dflt_$vrf_name$_$interface$ {
	            transmit-rate remainder;
	            buffer-size remainder;
	            priority low;
	        }
	        ctrl_$vrf_name$_$interface$ {
	            transmit-rate percent $ctrl_bw$;
	            buffer-size percent $ctrl_buff$;
	            priority high;
	        }
	    }
}
firewall {
    policer agg_vrf_[% vrf.rt %]_[% vrf.ifd %].[% vrf.ifl %]_policer {
        if-exceeding {
            bandwidth-limit $vrf_agg_police_bw;
            burst-size-limit $vrf_agg_police_burst;
        }
        then {
            discard;
        }
    }
    policer AF1_[% vrf.ifd %]$.[% vrf.ifl %]$ {
        if-exceeding {
            bandwidth-limit $vrf_af1_bw;
            burst-size-limit $vrf_af1_burst;
        }
        then {
            loss-priority low;
            forwarding-class FC-Q6;
        }
    }
    policer AF1_SAN_[% vrf.ifd %]$.[% vrf.ifl %]$ {
        if-exceeding {
            bandwidth-limit $vrf_af1_san_bw;
            burst-size-limit $vrf_af1_san_burst;
        }
        then {
			discard;
        }
    }
    policer AF2_SAN_[% vrf.ifd %]$.[% vrf.ifl %]$ {
        if-exceeding {
            bandwidth-limit $vrf_af2_san_bw;
            burst-size-limit $vrf_af2_san_burst;
        }
        then {
			discard;
        }
    }
    family inet {
        filter agg_vrf_[% vrf.rt %]_[% vrf.ifd %].[% vrf.ifl %] {
            interface-specific;
            term sp-ping {                   
                from {
                    source-prefix-list {
                        sp-ping-$subint;
                    }
                    protocol icmp;
                    icmp-type-except echo-reply;
                }                                   
                then {
                    count sp-ping-discard;
                    discard;
                }
            }
            term allowed-srcs-except {
                from {
                    source-prefix-list {
                        allowed-srcs-[% vrf.ifd %]$.[% vrf.ifl %]$ except;
                    }
                }
                then {
                    count discard-traffic;
                    discard;
                }
            }
            term Agg-policer {
                then {
                    policer agg_vrf_[% vrf.rt %]_[% vrf.ifd %].[% vrf.ifl %]_policer;
                    count all-permitted;
                    next term;
                }
            }
        }
        filter finex-cos-[% vrf.ifd %].[% vrf.ifl %] {
            term AF1_in {
                from {
                    dscp af11;
                }
                then {
                    policer AF1_[% vrf.ifd %]$.[% vrf.ifl %]$;
                    count AF_in;
                    loss-priority low;
                    forwarding-class FC-Q6;
                    accept;
                }
            }
            term AF1_out { 
                from {
                    dscp [ af12 af13 ];
                }
                then {
                    count AF1_out;
                    loss-priority high;
                    forwarding-class FC-Q6;
                    accept;
                }   
            }
            term default {
                then {
                    count BE;
                    loss-priority low;
                    forwarding-class FC-Q4;
                    accept;
                }
            }
        }
        filter AF2_SAN_vrf_[% vrf.rt %] {
            apply-groups AF2_SAN;
            term AF2_SAN-1-all {
                then count AF2_SAN-all;
            }
            term AF2_SAN-1-pol {
                then {
                    policer AF2_SAN_[% vrf.ifd %]$.[% vrf.ifl %]$;
                    loss-priority low;
                }
            }
            term AF2_SAN-1-ic {
                then count AF2_SAN-ic;
            }
            term AF2_SAN-1-oc {
                then count AF2_SAN-oc;
            }
		}
        filter AF1_SAN_vrf_[% vrf.rt %] {
            apply-groups AF1_SAN;
            term AF1_SAN-1-all {
                then count AF1_SAN-all;
            }
            term AF1_SAN-1-pol {
                then {
                    policer AF1_SAN_[% vrf.ifd %]$.[% vrf.ifl %]$;
                    loss-priority low;
                }
            }
            term AF1_SAN-1-ic {
                then count AF1_SAN-ic;
            }
            term AF1_SAN-1-oc {
                then count AF1_SAN-oc;
            }
		}

    }
}
routing-instances {
    $vrf$ {
        instance-type vrf;
        route-distinguisher $ASN:$RD_number;
        interface [% vrf.ifd %].[% vrf.ifl %];
        interface lo0.$grey_vrf_lo0_logical_int;
        vrf-import fv-import-$vrf$;
        vrf-export fv-export-$vrf$;
        vrf-table-label;
        routing-options {
            static {
                route $ce_loopback10$/32 {
                    next-hop $ce_ip_addr$;
                    bfd-liveness-detection {
                        no-adaptation;
                        minimum-interval 999;
                        multiplier 3;
                    }
                    community [ 12641:65050 12641:6125 ];
                }
                route $ce_ip_addr$/32 {
                    next-hop $ce_ip_addr$;
                    bfd-liveness-detection {
                        no-adaptation;
                        minimum-interval 999;
                        multiplier 3;
                    }
                    no-readvertise;
                }
            }
            auto-export;
            multipath;
        }
    }
    forwarding-options {
        family inet {
            filter {
                output $mcast_SAN_filter;
            }
        }
    }
    protocols {
        bgp {
            damping;
            group ebgp {
                type external;
                log-updown;
                neighbor $ce_ip_addr$ {
                    hold-time 30;
                    import [ CUSTOMER-BGP-DAMPING rm-ebgpin-$vrf$-$site_id$ soo-import-$vrf$-$site_id$  ];
                    family inet {
                        any {
                            prefix-limit {
                                maximum 500;
                                teardown 50 idle-timeout forever;
                            }
                        }
                    }
                    export [ soo-export-$vrf$-$site_id$  DENYBTPREFIX-SPRING ];
                    bfd-liveness-detection {
                        no-adaptation;
                        minimum-interval $bfd_minimum_interval$;
                        multiplier $bfd_multiplier$;
                    }
                    peer-as $CE_ASN;
                    as-override;
                }
            }
        }
    }
}
