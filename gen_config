#!/usr/bin/env ruby
require 'erb'
require 'yaml'
require 'ostruct'

unless ARGV[0]
  puts "Usage : #{$0} <YAML_FILE> [test]"
  puts "\t[test] is optional, if set output will be the YAML configuration"
  exit
end

yaml = YAML.load_file( ARGV[0] )

current_time = Time.now

# refactor this, it's shite code but works
if File.exist? './.gen_config.conf'
  app_conf = YAML.load_file( './.gen_config.conf' )
elsif File.exist? "#{ENV['HOME']}/.gen_config.conf"
  app_conf = YAML.load_file( "#{ENV['HOME']}/.gen_config.conf" )
elsif File.exist? '/etc/gen_config.conf'
  app_conf = YAML.load_file( '/etc/gen_config.conf' )
else
  app_conf = {'template' => 'templates'}
end

if ARGV[1] == "test"
  puts YAML::dump( yaml )
  exit
end
  puts '###### ' " generated at : #{current_time}, using YAML file :  #{ARGV[0]}\n" 
yaml.each do |config|
  @template = ERB.new( File.read( "#{app_conf['template']}/#{config['template']}" ) )
  c = OpenStruct.new( config )
  puts @template.result( c.send( :binding ) )
end
